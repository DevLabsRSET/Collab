<!DOCTYPE html>
<html class="no-js">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Collab</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body>
    <nav class="navbar navbar-light bg-transparent navbar-expand-lg">
        <a class="navbar-brand" href="#">
            <img src="./assets/images/logo.png" width="30" height="30" class="d-inline-block align-top" alt="">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup"
            aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
                <a class="nav-item nav-link" href="./index.html">Home</a>
                <a class="nav-item nav-link" href="#">Docs</a>
                <a class="nav-item nav-link" href="./guideNew.html">Write</a>
                <a class="nav-item nav-link active" href="./guide.html">Guide<span class="sr-only">(current)</span></a>
            </div>

        </div>
        <button class="btn btn-xs btn-outline-danger align-right" id="logout-button">Log Out</button>
    </nav>
    <div class="container">
        <div class="row mt-3">
            <div class="col-lg-12" id="contentHere">
                <!-- <div class="card text-center mt-3">
                    <div class="card-header" id="projectId">H123</div>
                    <div class="card-body">
                        <h5 class="card-title" id="header">Header</h5>
                        <p class="card-text" id="body">Body</p>
                        <button type="button" class="btn btn-outline-dark">Check</button>
                    </div>
                    <div class="card-footer text-muted" id="logDate">Timestamp</div>
                </div> -->
            </div>
        </div>
    </div>
    <script src="" async defer></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"
        integrity="sha384-6khuMg9gaYr5AxOqhkVIODVIvm9ynTT5J4V1cfthmT+emCG6yVmEZsRHdxlotUnm" crossorigin="anonymous">
    </script>
    <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-database.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCQRgYkdCyqtzGrvUnTEghX9UdGc-6f7fE",
            authDomain: "test-ckwtsw.firebaseapp.com",
            databaseURL: "https://test-ckwtsw.firebaseio.com",
            projectId: "test-ckwtsw",
            storageBucket: "test-ckwtsw.appspot.com",
            messagingSenderId: "640912972565",
            appId: "1:640912972565:web:8a0266535494dadea2271c"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();
        var ref = firebase.database().ref();
        var today = new Date();
        var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
        var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
        var dateTime = date + ' at ' + time;

        $("#logout-button").click(function (event) {
            event.preventDefault();
            firebase.auth().signOut().then(function () {
                // Sign-out successful.
                window.location.href = "login.html";
            }).catch(function (error) {
                // An error happened.
            });
        });

        function addToDom(key, data) {
            const container = document.getElementById("contentHere");
            // console.log("addToDom: "+key);
            const cardHtml = `
                <div class="card text-center mt-3">
                        <div class="card-header" id="projectId">${data.projectID}</div>
                        <div class="card-body">
                            <h5 class="card-title" id="header">${data.projectHeader}</h5>
                            <p class="card-text" id="body">${data.projectBody}</p>
                            <button type="button" class="btn btn-outline-dark" id="childKey" value="${key}" onclick="changeStatus(this)">Check</button>
                            <input type="hidden" id="uniqueKey"></input>
                        </div>
                        <div class="card-footer text-muted" id="logDate">${data.log}</div>
                    </div>`;
            const imageEl = document.createElement('div');
            imageEl.classList.add("col-12", "col-md-12")
            imageEl.innerHTML = cardHtml;
            container.appendChild(imageEl);
        }

        function addToDomChecked(key, data) {
            const container = document.getElementById("contentHere");
            const cardHtml = `
            <div class="card border-success text-center mt-3">
                    <div class="card-header" id="projectId">${data.projectID}</div>
                    <div class="card-body">
                        <h5 class="card-title text-success" id="header">${data.projectHeader}</h5>
                        <p class="card-text text-success" id="body">${data.projectBody}</p>
                    </div>
                    <div class="card-footer text-muted" id="logDate">${data.log}</div>
                </div>`;
            const imageEl = document.createElement('div');
            imageEl.classList.add("col-12", "col-md-12")
            imageEl.innerHTML = cardHtml;
            container.appendChild(imageEl);
        }

        function changeStatus(obj) {
            var uniqueId = obj.value;
            // console.log("Change Status:" + uniqueId);
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    uid = firebase.auth().currentUser.uid;
                    email = firebase.auth().currentUser.email;
                    // console.log(uid);
                    firebase.database().ref().child('projectid').once("value",
                        function (snapshot) {
                            // console.log('here');
                            // console.log("unique id inside auth:" + uniqueId);
                            var tId = snapshot.child(uid).val();
                            firebase.database().ref(tId + '/' + uniqueId + '/status').set("ok");
                        }
                    )
                }
                $(body).empty();
                // setTimeout(function () {
                //     location.reload();
                // }, 2000)
            });

        };
        $(document).ready(function () {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    uid = firebase.auth().currentUser.uid;
                    email = firebase.auth().currentUser.email;
                    // console.log(uid);
                    // console.log(email);
                    // console.log('here2');

                    firebase.database().ref().child('projectid').once("value",
                        function (
                            snapshot) {
                            // console.log('here');
                            var tId = snapshot.child(uid).val();
                            // console.log("tId: " + tId);
                            const values = [];
                            var leadsRef = database.ref(tId + '/');
                            leadsRef.on('value', function (snapshot) {
                                snapshot.forEach(function (
                                    childSnapshot) {
                                    var childKey =
                                        childSnapshot
                                        .key;
                                    console.log(childKey);
                                    var childData =
                                        childSnapshot
                                        .val();
                                    values.push({
                                        childKey,
                                        childData
                                    });
                                    // console.log(childData.log)
                                });
                                values.reverse().map((value) => {
                                    if (value.childData.status == "ok") {
                                        addToDomChecked(value.childKey, value
                                            .childData);
                                    } else {
                                        addToDom(value.childKey, value.childData);
                                    }
                                });
                                $(body).empty();
                                // console.log(values);
                                // console.log(values.log);
                            });

                        })

                } else {
                    // No user is signed in.

                }
            })
        })
    </script>
</body>

</html>